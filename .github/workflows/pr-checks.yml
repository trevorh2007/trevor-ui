name: Pull Request Checks

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  statuses: write

jobs:
  quality-gate:
    name: üõ°Ô∏è Quality Gate
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: üì¶ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: üîç Type check
        run: npm run type-check

      - name: üíÑ Check code formatting
        run: npm run format:check

      - name: üîß Run linting
        run: npm run lint

      - name: üß™ Run tests with coverage
        run: npm run test:ci

      - name: üèóÔ∏è Test build
        run: npm run build

      - name: üìä Generate and comment coverage report
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');

            // Generate test and coverage report
            let coverageContent = '';
            let testSummary = '';

            try {
              // Run tests with coverage and verbose output
              const testOutput = execSync('npm run test:ci -- --verbose --coverage', { 
                encoding: 'utf8',
                maxBuffer: 1024 * 1024 * 10 // 10MB buffer
              });
              
              console.log('Full test output length:', testOutput.length);
              console.log('Test output preview:', testOutput.substring(0, 500));
              
              const lines = testOutput.split('\n');
              
              // Find Jest test summary (appears at the end)
              const testSuiteIndex = lines.findIndex(line => line.trim().startsWith('Test Suites:'));
              if (testSuiteIndex !== -1) {
                const summaryLines = [];
                for (let i = testSuiteIndex; i < lines.length && i < testSuiteIndex + 10; i++) {
                  const line = lines[i];
                  if (line.trim().startsWith('Test Suites:') || 
                      line.trim().startsWith('Tests:') || 
                      line.trim().startsWith('Snapshots:') ||
                      line.trim().startsWith('Time:')) {
                    summaryLines.push(line);
                  }
                }
                testSummary = summaryLines.join('\n');
                console.log('Found test summary:', testSummary);
              } else {
                console.log('Could not find Test Suites line');
                // Debug: show all lines that might contain test info
                lines.forEach((line, index) => {
                  if (line.includes('Test') || line.includes('passed') || line.includes('total')) {
                    console.log(`Line ${index}: ${line}`);
                  }
                });
              }
              
              // Find coverage table - look for the table header
              const coverageTableStart = lines.findIndex(line => 
                line.includes('File') && line.includes('% Stmts') && line.includes('|')
              );
              
              if (coverageTableStart !== -1) {
                const coverageLines = [];
                // Get table starting from header
                for (let i = coverageTableStart; i < lines.length && i < coverageTableStart + 20; i++) {
                  const line = lines[i];
                  // Include header, separator, and data rows
                  if (line.includes('|') || line.includes('---------')) {
                    coverageLines.push(line);
                  }
                  // Stop when we hit an empty line after getting some content
                  if (line.trim() === '' && coverageLines.length > 3) {
                    break;
                  }
                }
                coverageContent = coverageLines.join('\n');
                console.log('Found coverage table:', coverageContent);
              } else {
                console.log('Could not find coverage table header');
                // Debug: show lines that might contain coverage info
                lines.forEach((line, index) => {
                  if (line.includes('%') || line.includes('File') || line.includes('All files')) {
                    console.log(`Line ${index}: ${line}`);
                  }
                });
              }
              
            } catch (error) {
              console.error('Error running tests:', error);
              console.error('Error details:', error.message);
              
              // If the script fails, we still want to show something meaningful
              testSummary = 'Error: Could not parse test results - check workflow logs';
              coverageContent = 'Error: Could not parse coverage report - check workflow logs';
            }

            // Determine overall status
            const allJobsPassed = '${{ job.status }}' === 'success';
            const statusEmoji = allJobsPassed ? '‚úÖ' : '‚ùå';
            const statusText = allJobsPassed ? 'All checks passed!' : 'Some checks failed';

            // Create PR comment
            const comment = `## ${statusEmoji} Quality Gate Report

            ### üß™ Test Results
            \`\`\`
            ${testSummary}
            \`\`\`

            ### üìä Coverage Report
            \`\`\`
            ${coverageContent}
            \`\`\`

            ### üéØ Quality Checks Status
            ${allJobsPassed ? '‚úÖ All quality checks passed successfully!' : '‚ùå Some quality checks failed - see workflow details above'}

            **Overall Status: ${statusText}**

            ---
            <sub>ü§ñ Generated automatically by [GitHub Actions](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})</sub>`;

            // Find and update existing comment or create new one
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.body.includes('Quality Gate Report') && 
              (comment.user.type === 'Bot' || comment.user.login === 'github-actions[bot]')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: üéØ Set final status check
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? 'success' : 'failure';

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: status,
              target_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: status === 'success' ? 'All quality checks passed' : 'Quality checks failed',
              context: 'ci/quality-gate'
            });
